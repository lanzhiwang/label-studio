# Deploy Label Studio on Kubernetes

* https://labelstud.io/guide/install_k8s

Deploy Label Studio on a Kubernetes Cluster using Helm 3. You can use this Helm chart to set up Label Studio for deployment onto a Kubernetes cluster and install, upgrade, and manage the application.
使用 Helm 3 在 Kubernetes 集群上部署 Label Studio。您可以使用此 Helm 图表设置 Label Studio 以部署到 Kubernetes 集群并安装、升级和管理应用程序。

Your Kubernetes cluster can be self-hosted or installed somewhere such as Amazon EKS. See the Amazon tutorial on how to [Deploy a Kubernetes Application with Amazon Elastic Container Service for Kubernetes](https://aws.amazon.com/getting-started/hands-on/deploy-kubernetes-app-amazon-eks/) for more about deploying an app on Amazon EKS.
您的 Kubernetes 集群可以自托管或安装在 Amazon EKS 等位置。 有关在 Amazon EKS 上部署应用程序的更多信息，请参阅有关如何使用 Amazon Elastic Container Service for Kubernetes 部署 Kubernetes 应用程序的 Amazon 教程。

> WARNING
> To install Label Studio Enterprise Edition, see [Deploy Label Studio Enterprise on Kubernetes](https://labelstud.io/guide/install_enterprise_k8s.html). This page is specific to the community version of Label Studio.
> 要安装 Label Studio Enterprise Edition，请参阅在 Kubernetes 上部署 Label Studio Enterprise。 此页面特定于 Label Studio 社区版本。

## Install Label Studio on Kubernetes

If you want to install Label Studio on Kubernetes and you have unrestricted access to the internet from your K8s cluster, follow these steps.

1. Verify that you meet the [Required software prerequisites](https://labelstud.io/guide/install_k8s#Required-software-prerequisites) and review the [capacity planning](https://labelstud.io/guide/install_k8s#Capacity-planning) guidance.

2. [Prepare the Kubernetes cluster](https://labelstud.io/guide/install_k8s#Prepare-the-Kubernetes-cluster).

3. [Add the Helm chart repository](https://labelstud.io/guide/install_k8s#Add-the-Helm-chart-repository).

4. (Optional) Set up [persistent storage](https://labelstud.io/guide/persistent_storage).

5. (Optional) Configure [ingress](https://labelstud.io/guide/ingress_config).

6. (Optional) Configure [values.yaml](https://labelstud.io/guide/helm_values).

7. (Optional) [Set up TLS for PostgreSQL](https://labelstud.io/guide/install_k8s#Optional-set-up-TLS-for-PostgreSQL)

8. (Optional) [Set up TLS for Redis](https://labelstud.io/guide/install_k8s#Optional-set-up-TLS-for-Redis)

9.  [Use Helm to install Label Studio on your Kubernetes cluster](https://labelstud.io/guide/install_k8s#Use-Helm-to-install-Label-Studio-on-your-Kubernetes-cluster).

If you use a proxy to access the internet from your Kubernetes cluster, or it is airgapped from the internet, see how to [Install Label Studio without public internet access](https://labelstud.io/guide/install_airgapped.html).

### Required software prerequisites

- Kubernetes and kubectl version 1.17 or higher
- Helm version 3.6.3 or higher

This chart has been tested and confirmed to work with the [NGINX Ingress Controller](https://kubernetes.github.io/ingress-nginx/) and [cert-manager](https://cert-manager.io/docs/). See [Set up an ingress controller for Label Studio Kubernetes deployments](https://labelstud.io/guide/ingress_config) for more on ingress settings with Label Studio.

Your Kubernetes cluster can be self-hosted or installed somewhere such as Amazon EKS.

### Capacity planning

To plan the capacity of your Kubernetes cluster, refer to these guidelines.

Label Studio has the following default configurations for resource requests, resource limits, and replica counts:

```yaml
app:
  replicas: 1
  resources:
    requests:
      memory: 1024Mi
      cpu: 1000m
    limits:
      memory: 6144Mi
      cpu: 4000m
```

Before you make changes to these values, familiarize yourself with the [Resource Management for Pods and Containers](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) guidelines in the Kubernetes documentation.

If you choose to make changes to these default settings, consider the following:

| For this case                      | Adjust this                                                                                     |
| ---------------------------------- | ----------------------------------------------------------------------------------------------- |
| More than 10 concurrent annotators | Adjust the requests and limits for `resources` in the `app` pod                                 |
| Increase fault tolerance           | Increase the number of replicas of `app` pod                                                    |
| Production deployment (replicas)   | Replicas equivalent or greater than the number of availability zones in your Kubernetes cluster |

### Prepare the Kubernetes cluster

Before installing Label Studio, prepare the Kubernetes cluster with [kubectl](https://kubernetes.io/docs/reference/kubectl/).

### Add the Helm chart repository

Add the Helm chart repository to easily install and update Label Studio.

1. From the command line:

```bash
helm repo add heartex https://charts.heartex.com/
helm repo update heartex
```

2. If you want, check for available versions:

```bash
helm search repo heartex/label-studio
```

## Optional: set up TLS for PostgreSQL

To configure Label Studio to use TLS for end-client connections with PostgreSQL, do the following:

1. Enable TLS for your PostgreSQL instance and save Root TLS certificate, client certificate and its key for the next steps.
2. Create a Kubernetes secret with your certificates, replacing `<PATH_TO_CA>`, `<PATH_TO_CLIENT_CRT>` and `<PATH_TO_CLIENT_KEY>` with paths to your certificates:

```bash
kubectl create secret generic <YOUR_SECRET_NAME> --from-file=ca.crt=<PATH_TO_CA> --from-file=client.crt=<PATH_TO_CLIENT_CRT> --from-file=client.key=<PATH_TO_CLIENT_KEY>
```

3. Update your `ls-values.yaml` file with your newly-created Kubernetes secret:

> NOTE
> If `POSTGRE_SSL_MODE: verify-ca`, the server is verified by checking the certificate chain up to the root certificate stored on the client. If `POSTGRE_SSL_MODE: verify-full`, the server host name will be verified to make sure it matches the name stored in the server certificate. The SSL connection will fail if the server certificate cannot be verified. `verify-full` is recommended in most security-sensitive environments.

```yaml
global:
  pgConfig:
    ssl:
      pgSslMode: "verify-full"
      pgSslSecretName: "<YOUR_SECRET_NAME>"
      pgSslRootCertSecretKey: "ca.crt"
      pgSslCertSecretKey: "client.crt"
      pgSslKeySecretKey: "client.key"
```

4. Install or upgrade Label Studio using Helm.

## Optional: set up TLS for Redis

To configure Label Studio to use TLS for end-client connections with Redis, do the following:

1. Enable TLS for your Redis instance and save Root TLS certificate, client certificate and its key for the next steps.
2. Create a Kubernetes secret with your certificates, replacing `<PATH_TO_CA>`, `<PATH_TO_CLIENT_CRT>` and `<PATH_TO_CLIENT_KEY>` with paths to your certificates:

```bash
kubectl create secret generic <YOUR_SECRET_NAME> --from-file=ca.crt=<PATH_TO_CA> --from-file=client.crt=<PATH_TO_CLIENT_CRT> --from-file=client.key=<PATH_TO_CLIENT_KEY>
```

3. Update your `ls-values.yaml` file with your newly-created Kubernetes secret:

> NOTE
> In the case if you are using self-signed certificates that host cannot verify you have to set `redisSslCertReqs` to `None`

```yaml
global:
  redisConfig:
    ssl:
      redisSslCertReqs: "required"
      redisSslSecretName: "<YOUR_SECRET_NAME>"
      redisSslCaCertsSecretKey: "ca.crt"
      redisSslCertFileSecretKey: "client.crt"
      redisSslKeyFileSecretKey: "client.key"
```

4. Install or upgrade Label Studio using Helm.

### Use Helm to install Label Studio on your Kubernetes cluster

Use Helm to install Label Studio on your Kubernetes cluster. Provide your custom resource definitions YAML file. Specify any environment variables that you need to set for your Label Studio installation using the `--set` argument with the `helm install` command.

From the command line, run the following:

```bash
helm install <RELEASE_NAME> heartex/label-studio -f ls-values.yaml
```

After installing, check the status of the Kubernetes pod creation:

```bash
kubectl get pods
```

## Restart Label Studio using Helm

Restart your Helm release by doing the following from the command line:

1. Identify the <RELEASE_NAME> of the latest Label Studio release:

```bash
helm list
```

2. Restart the Label Studio app:

```bash
kubectl rollout restart deployment/<RELEASE_NAME>-ls-app
```

## Upgrade Label Studio using Helm

To upgrade Label Studio using Helm, do the following.

1. Determine the latest tag version of Label Studio and add/replace the following in your `ls-values.yaml` file:

```yaml
global:
  image:
    tag: "20210914.154442-d2d1935"
```

2. After updating the values file, retrieve the latest updates for the Helm chart:

```bash
helm repo update heartex
```

3. Run the following from the command line to upgrade your deployment:

```bash
helm upgrade <RELEASE_NAME> heartex/label-studio -f ls-values.yaml
```

   If you want, you can specify a version from the command line:

```bash
helm upgrade <RELEASE_NAME> heartex/label-studio -f ls-values.yaml --set global.image.tag=20210914.154442-d2d1935
```

   This command overrides the tag value stored in `ls-values.yaml`. You must update the tag value when you upgrade or redeploy your instance to avoid version downgrades.

## Uninstall Label Studio using Helm

To uninstall Label Studio using Helm, delete the configuration.

From the command line, run the following:

```bash
helm delete <RELEASE_NAME>
```
